# MatgoEngine 게임 규칙 (절대 변경 금지)

## 개요
이 파일은 `lib/utils/matgo_engine.dart`의 모든 게임 규칙을 정의합니다. 
엔진 관련 수정 시 반드시 이 파일을 참고하여 일관성을 유지해야 합니다.

## 턴 시스템 (TurnPhase)

### 턴 단계
- `playingCard`: 손패에서 카드 내는 단계
- `flippingCard`: 카드더미에서 카드 뒤집는 단계  
- `choosingMatch`: 따닥 발생 시 카드 선택 단계
- `turnEnd`: 턴 종료 및 정산 단계

## 게임 진행 규칙

### 1. 카드 내기 (playCard)
- **폭탄카드**: 필드에 추가하지 않고 카드더미에서 바로 한 장 뒤집기
- **보너스카드**: 즉시 캡처하고 카드더미에서 한 장 교체, 턴 계속 유지 (일반카드 낼 때까지 반복)
- **뻑 완성**: 4장 모두 먹기 + 피 강탈 + 뻑 상태 초기화
- **폭탄**: 손패 3장+필드 1장 조건, 4장 모두 먹기 + 피 강탈 + 폭탄카드 2장 획득
- **일반 매치**: 1장/2장/3장 매치에 따른 처리

### 2. 카드 뒤집기 (flipFromDeck)
- **보너스피 연속 처리**: 보너스가 아닐 때까지 계속 뒤집기
- **처리 순서**: 뻑 완성 → 쪽 → 뻑 발생 → 따닥 → 일반 매치
- **카드 소진**: 뒤집을 카드가 없으면 턴 종료

### 3. 따닥 처리 (chooseMatch)
- 첫 번째 2장 매치 선택 후 두 번째 2장 매치 확인
- 두 번째 2장 매치가 있으면 두 번째 선택창 표시
- 선택한 카드만 획득, 선택 안 한 카드는 필드에 남김

### 4. 턴 종료 (_endTurn)
- pendingCaptured의 카드들을 실제 획득 영역으로 이동
- 뻑 상태가 아닌 경우에만 보너스피 획득
- 쓸(Sseul) 조건 체크 및 처리
- **GO/STOP 판정**: 모든 특수 규칙 처리 후 가장 마지막에 실행
  - 7점 이상 달성 시 GO/STOP 선택 대기
  - 역GO 발생 시 즉시 승리 처리
- 다음 플레이어로 턴 전환

## 특수 규칙

### 흔들 (Heundal)
- **조건**: 손패에 같은 월 3장 이상 + 필드에 같은 월 카드 없음
- **효과**: 점수 2배 (게임 종료 시 적용)
- **선언**: 카드 내기 전에 흔들 다이얼로그 표시

### 폭탄 (Bomb)
- **조건**: 손패 3장 + 필드 1장 이상 (같은 월)
- **효과**: 4장 모두 먹기 + 피 강탈 + 폭탄카드 2장 획득 + 점수 2배
- **자동 처리**: 흔들 다이얼로그 표시하지 않음

### 뻑 (Ppeok)
- **뻑 발생 조건**: 바닥(필드)에 같은 월 1장, 내가 같은 월 1장 내고, 카드더미에서 같은 월 1장 뒤집어서 총 3장이 한 번에 모이면 뻑 발생
- **처리**: 이 3장은 모두 필드에 남기고(누구도 먹지 않음), 뻑 상태 진입
- **뻑 완성 조건**: 필드에 뻑 무더기(같은 월 3장)가 쌓여 있는 상태에서 내가 같은 월 1장 내거나, 카드더미에서 같은 월 1장 더 뒤집어서 총 4장이 되면 뻑 완성
- **처리**: 4장 모두 내가 먹고, 피 1장 강탈
- **특이사항**: 뻑 상태에서는 해당 월의 카드를 또 내거나 뒤집을 때까지 필드에 3장이 남아 있음
- **애니메이션/로그**: 뻑 발생/완성 시 각각 특수 연출 및 로그 기록

### 쪽 (Chok)
- **조건**: 내가 낸 카드와 뒤집은 카드가 같은 월
- **효과**: 두 카드 모두 먹기 + 피 강탈

### 따닥 (Ttak)
- **조건**: 필드에 같은 월 2장 + 내가 낸 카드와 같은 월
- **처리**: 뒤집은 카드와 매치되는 필드 카드 선택

### 쓸 (Sseul)
- **조건**: 바닥(필드)이 0장 됨
- **효과**: 상대방 피 1장 강탈

### 역GO (Go Bust)
- **조건**: GO 상태에서 상대방이 7점 이상 달성
- **결과**: 상대방 승리, GO/STOP 배수 무시

## 점수 계산 규칙

### 기본 점수
- **광**: 3광=3점(비광포함시 2점), 4광=4점, 5광이상=15점
- **띠**: 5띠=1점, 6띠=2점, 7띠=3점
- **고도리**: 2,4,8월 동물(열끗) 3종 모으면 5점
- **단**: 청단/홍단/초단 각각 3점
- **피**: 10피부터 1점, 이후 1피당 +1점
- **동물(열끗)**: 5장부터 1점, 이후 1장당 +1점

### 배수 규칙
- **GO**: 1GO=+1점, 2GO=+2점, 3GO이상=기본점수×2^(GO-2)
- **흔들**: 점수 2배 (중첩 가능)
- **폭탄**: 점수 2배 (중첩 가능)
- **피박**: 게임 종료 시 점수 2배 (승자가 피 점수 획득 + 패자가 피 6장 이하)
- **광박**: 게임 종료 시 점수 2배 (승자가 광 점수 획득 + 패자가 광 0장)
- **멍박**: 게임 종료 시 점수 2배 (승자가 동물 점수 획득 + 패자가 동물 7장 미만)
- **나가리**: 무승부 다음 판 승점 ×2 (최대 ×16까지 누적)

## 피 강탈 규칙
- **우선순위**: 일반피 → 쌍피 → 보너스피
- **제한**: 각 종류별로 1장씩만 강탈
- **이동**: 강탈한 피는 즉시 내 획득 카드로 이동

## 승리 조건 및 GO/STOP 판정

### GO/STOP 판정 순서
1. **특수 규칙 처리**: 폭탄, 피 강탈, 뻑, 쪽, 따닥, 쓸 등 모든 특수 규칙 처리
2. **점수 계산**: 현재 플레이어의 점수 계산
3. **GO/STOP 판정**: 7점 이상 달성 시 GO/STOP 선택 대기
4. **박 판정**: GO/STOP 선택 후 게임 종료 시 최종 박 판정 처리

### 승리 조건
- **기본**: 7점 이상 달성 시 고/스톱 선택
- **GO 선언**: 게임 계속, 배수 증가 (박 판정은 게임 종료 시)
- **STOP 선언**: 즉시 승리 (박 판정 즉시 처리)
- **역GO**: 상대방이 7점 이상 달성 시 상대방 승리 (박 판정은 게임 종료 시)

### 박 판정 처리 시점
- **STOP 선언 시**: 즉시 박 판정 처리
- **게임 종료 시**: 최종 박 판정 처리 (GO 선언 후 게임 종료 시)
- **역GO 발생 시**: 게임 종료 시 박 판정 처리

## 상태 관리

### 게임 상태 변수
- `currentPlayer`: 현재 플레이어 (1 또는 2)
- `goCount`: GO 선언 횟수
- `goPlayer`: GO를 선언한 플레이어
- `gameOver`: 게임 종료 여부
- `winner`: 승자 플레이어
- `awaitingGoStop`: 고/스톱 선택 대기 상태

### 턴 상태 변수
- `currentPhase`: 현재 턴 단계
- `playedCard`: 이번 턴에 낸 카드
- `drawnCard`: 뒤집은 카드
- `pendingCaptured`: 이번 턴에 획득할 예정인 카드들
- `choices`: 따닥 발생 시 선택할 카드들
- `ppeokMonth`: 뻑이 발생한 월
- `hadTwoMatch`: 카드 내기 단계에서 2장 매치가 있었는지 여부
- `bonusOverlayCards`: 보너스피 임시 저장 버퍼

### 배수 플래그
- `bombPlayers`: 폭탄 선언한 플레이어 번호 집합
- `heundalPlayers`: 흔들 선언한 플레이어 번호 집합
- `piBakPlayers`: 피박 플레이어 번호 집합
- `gwangBakPlayers`: 광박 플레이어 번호 집합
- `mungBakPlayers`: 멍박 플레이어 번호 집합
- `nagariCount`: 나가리 횟수 (최대 4회, ×16까지)

## 애니메이션 이벤트
- `cardFlip`: 카드 뒤집기
- `cardMove`: 카드 이동
- `specialEffect`: 특수 효과 (뻑, 따닥 등)
- `cardCapture`: 카드 획득
- `bonusCard`: 보너스 카드
- `ppeok`: 뻑 발생 애니메이션
- `piSteal`: 피 강탈 애니메이션
- `sseul`: 쓸 발생 애니메이션

## 옵션 규칙 (구현 여부 결정 필요)

### 지역별 변형 규칙
- **12월 쌍피 인정**: 12월 띠/피를 쌍피로 사용
- **첫따닥·첫뻑 보너스**: 3점 상당 금액 즉시 지급
- **두 장 폭탄**: 바닥 2장 + 손 2장 = 폭탄 허용
- **조커 2피·3피 사용**: 난이도·점수 증가

### 용어 정리
- **열끗**: 동물 카드 (새·동물 그림)
- **굳은자**: 이미 2장 먹힌 월의 남은 패
- **나가리**: 무승부, 다음 판 배수 적용

## 주의사항
- 이 규칙들은 절대 변경하지 마세요
- 엔진 수정 시 반드시 이 파일을 참고하세요
- 게임의 일관성과 정확성을 위해 모든 규칙을 준수해야 합니다

### [실제 구현 예외 및 상세 분기]

#### 2장 매치(따닥) 선택창/뒤집은 카드 처리
- 2장 매치 상황에서 선택창이 뜨면, 플레이어는 2장 중 1장만 선택할 수 있다.
- **선택한 카드만 먹고, 선택하지 않은 카드는 필드에 남긴다.**
- 카드더미에서 뒤집은 카드가 2장 매치가 아니면, **뒤집은 카드는 필드에 남고 먹은 카드로 분류되지 않는다.**
- 카드더미에서 뒤집은 카드가 2장 매치라면, 두 번째 선택창이 뜨고 동일하게 처리한다.
- (예시) 2장 매치 후 뒤집은 카드가 매치가 없으면, 필드에 남아야 한다.

#### 2장 매치(따닥 아님) 예외 처리
- 2장 매치 상황에서 두 카드가 모두 일반 1피(쌍피/보너스피/특수피 아님)일 경우, 선택창을 띄우지 않고 자동으로 아무 카드나 먹는다.
- (예시) 2장 모두 일반 1피면 첫 번째 카드를 자동으로 먹고, 선택창은 노출되지 않는다.
- **단, 내가 낸 카드가 일반피가 아닌 경우(예: 8광 등)에는 선택창 없이 일반피를 먹되, 내가 낸 카드(예: 8광)도 반드시 같이 먹는다.**

#### 뻑 완성 처리
- 필드에 뻑 월 3장이 쌓인 상태에서 내가 같은 월 1장 내거나, 카드더미에서 같은 월 1장 더 뒤집어서 총 4장이 되면 **뻑 완성**
- **뻑 완성 시 4장 모두를 획득 카드로 이동**하고, 필드에서는 해당 월 카드들을 제거한다.
- 피 1장 강탈도 즉시 처리한다.

#### 보너스피 처리
- 카드더미에서 보너스피가 나오면, 내가 낸 손패카드 위에 겹치고 한 장 더 뒤집는다.
- 보너스피가 연속으로 나오면, 보너스가 아닐 때까지 반복한다.
- 보너스피가 아닌 카드가 나왔는데 그 카드로 인해 뻑이 발생하면, **보너스피까지 전부 뻑에 묶여서 가져오지 않는다.**
